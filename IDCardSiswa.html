<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>ID Card Siswa — Debug Friendly</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f8ff;color:#222;padding:20px;text-align:center}
    .card{display:inline-block;background:#fff;padding:18px;border-radius:10px;border:1px solid #d0d7e6;box-shadow:0 6px 18px rgba(0,0,0,0.06);max-width:420px}
    img{width:160px;height:auto;border-radius:8px;border:2px solid #0077cc;margin-top:8px}
    .debug{margin-top:18px;text-align:left;font-size:13px;color:#444;background:#fff;padding:10px;border-radius:8px;border:1px dashed #ccc;max-width:900px;margin-left:auto;margin-right:auto;overflow:auto}
    .warn{color:#b33}
  </style>
</head>
<body>
  <h1>ID Card Siswa — JR EDUCATION</h1>

  <div id="result">
    <p>Memuat data... (cek console jika lama)</p>
  </div>

  <div class="debug" id="debug">
    <strong>Debug info:</strong>
    <div id="dbgContent">Belum ada log.</div>
  </div>

  <script>
    // ----- CONFIG: ganti kalau perlu -----
    const SHEET_URL = "https://opensheet.elk.sh/1LWHkjnO6BZ-QC9CjxEStDiqklgQ_ZYSFoVgLtokf3PM/IDCard";
    // ------------------------------------

    function logDebug(msg) {
      console.log(msg);
      const el = document.getElementById('dbgContent');
      el.innerHTML = (el.innerHTML ? el.innerHTML + "<br>" : "") + msg;
    }

    function normalizeNis(s){
      if (s === undefined || s === null) return "";
      return String(s).trim().replace(/\s+/g,'').replace(/\./g,'').toLowerCase();
    }

    (async function(){
      const params = new URLSearchParams(window.location.search);
      const nisParam = params.get('nis');
      const resultDiv = document.getElementById('result');

      if(!nisParam){
        resultDiv.innerHTML = "<p class='warn'>NIS tidak ditemukan di URL. Contoh: ?nis=2425.17.85</p>";
        logDebug("Tidak ada parameter nis di URL.");
        return;
      }

      logDebug("Parameter nis (dari URL): " + nisParam);
      resultDiv.innerHTML = "<p>Memuat data untuk NIS: <b>" + nisParam + "</b> …</p>";

      try {
        logDebug("Memanggil opensheet: " + SHEET_URL);
        const res = await fetch(SHEET_URL, {cache: "no-store"});
        logDebug("Status response: " + res.status + " " + res.statusText);

        if (!res.ok) {
          const text = await res.text().catch(()=>"[tidak bisa baca body]");
          logDebug("Response bukan OK. body: " + text);
          throw new Error("Response not OK: " + res.status);
        }

        const data = await res.json();
        logDebug("Jumlah record dari sheet: " + (Array.isArray(data) ? data.length : "bukan array"));
        // tampilkan 3 sampel jika ada
        if (Array.isArray(data)) logDebug("Contoh 3 record: " + JSON.stringify(data.slice(0,3)));

        // Cari berdasarkan NIS (normalisasi: hapus spasi dan titik, case-insensitive)
        const normTarget = normalizeNis(nisParam);
        logDebug("Normalisasi nis target: " + normTarget);

        const found = data.find(item => {
          // beberapa sheet punya kolom 'NIS' atau 'nis' atau 'Nis' — jadikan robust:
          const keys = Object.keys(item);
          // cari properti yang mendekati NIS
          const nisFieldKey = keys.find(k => k.toLowerCase() === 'nis') || keys.find(k=> k.toLowerCase().includes('nis'));
          const val = nisFieldKey ? item[nisFieldKey] : item['NIS'] || item['nis'] || item['Nis'];
          const normVal = normalizeNis(val);
          return normVal === normTarget;
        });

        console.log("found raw:", found);
        if (found) {
          // cari field foto (bisa NAMA: FOTO atau photo)
          const keys = Object.keys(found);
          const fotoKey = keys.find(k => k.toLowerCase().includes('foto')) || keys.find(k => k.toLowerCase().includes('photo')) || 'FOTO';
          const namaKey = keys.find(k => k.toLowerCase().includes('nama')) || 'NAMA';
          const sekolahKey = keys.find(k => k.toLowerCase().includes('sekolah')) || 'SEKOLAH';

          const fotoUrl = found[fotoKey] || found['FOTO'] || found['foto'] || "";
          const nama = found[namaKey] || found['NAMA'] || "";
          const sekolah = found[sekolahKey] || found['SEKOLAH'] || "";

          resultDiv.innerHTML = `
            <div class="card">
              <h2>Siswa berikut merupakan siswa JR EDUCATION</h2>
              ${ nama ? `<p><b>Nama:</b> ${nama}</p>` : "" }
              <p><b>NIS:</b> ${found.NIS || found.nis || nisParam}</p>
              ${ sekolah ? `<p><b>Sekolah:</b> ${sekolah}</p>` : "" }
              ${ fotoUrl ? `<img src="${fotoUrl}" alt="Foto Siswa" onerror="this.style.display='none'; document.getElementById('dbgContent').innerHTML += '<br>Gagal muat foto (url rusak).';">` : `<p style="color:#b33">Foto tidak tersedia</p>` }
            </div>
          `;
          logDebug("Siswa ditemukan. FotoKey: " + fotoKey + " | fotoUrl: " + (fotoUrl?fotoUrl:"(kosong)"));
        } else {
          resultDiv.innerHTML = `<p class="warn">❌ Data siswa dengan NIS <b>${nisParam}</b> tidak ditemukan.</p>
            <p>Periksa: (1) NIS di QR & sheet persis sama; (2) Sheet 'IDCard' sudah share publik; (3) Kolom header bernama 'NIS' / 'NAMA' / 'FOTO'.</p>`;
          logDebug("Tidak ditemukan record yang matching. Coba periksa format NIS di sheet.");
        }

      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="warn">⚠️ Terjadi kesalahan saat mengambil data (lihat debug di bawah).</p>`;
        logDebug("Error saat fetch/parsing: " + (err && err.message ? err.message : String(err)));
        logDebug("Jika error berisi 'Unable to parse range' → pastikan nama sheet persis 'IDCard' dan sudah dishare publik.");
        logDebug("Jika error CORS/Network → cek console network atau coba buka link JSON langsung di tab browser.");
      }
    })();
  </script>
</body>
</html>
